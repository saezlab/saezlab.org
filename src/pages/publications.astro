---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import PublicationsTabsLoaded from '../components/PublicationsTabs';
import type { Publication } from '../types/types';

// Get all publications from the content collection
const publications = await getCollection('publications_loaded');
const featuredPublicationRows = await getCollection('featured_publications');

// Check if we have any publications
if (!publications || publications.length === 0) {
  console.error('No publications found in the collection');
}

// Get the publications data with error handling
const allPublications = publications?.[0]?.data?.publications || [];

// Filter publications to only include those after July 2010
const publicationsData = allPublications.filter(pub => {
  if (!pub.date) return false;
  // Filter publications after July 2010 (2010-07-01)
  return pub.date > '2010-07-01';
});

const normalizeValue = (value?: string) => (value || '').trim().toLowerCase();
const normalizeTitle = (title?: string) =>
  normalizeValue(title)
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, ' ')
    .trim();

const publicationsByPmid = new Map<string, Publication>();
const publicationsByDoi = new Map<string, Publication>();
const publicationsByTitle = new Map<string, Publication>();
const featuredPublicationKeys = new Set<string>();

for (const publication of publicationsData) {
  const pmidKey = normalizeValue(publication.pmid);
  const doiKey = normalizeValue(publication.doi);
  const titleKey = normalizeTitle(publication.title);

  if (pmidKey && !publicationsByPmid.has(pmidKey)) {
    publicationsByPmid.set(pmidKey, publication);
  }
  if (doiKey && !publicationsByDoi.has(doiKey)) {
    publicationsByDoi.set(doiKey, publication);
  }
  if (titleKey && !publicationsByTitle.has(titleKey)) {
    publicationsByTitle.set(titleKey, publication);
  }
}

const featuredPublications = featuredPublicationRows
  .reduce((ordered: Publication[], row) => {
    const pmidKey = normalizeValue(row.data.featured_pmid);
    const doiKey = normalizeValue(row.data.featured_doi);
    const titleKey = normalizeTitle(row.data.featured_title);

    let match: Publication | undefined;
    if (pmidKey) {
      match = publicationsByPmid.get(pmidKey);
    }
    if (!match && doiKey) {
      match = publicationsByDoi.get(doiKey);
    }
    if (!match && titleKey) {
      match = publicationsByTitle.get(titleKey);
    }
    if (!match) return ordered;

    const matchKey =
      (match.pmid && `pmid:${normalizeValue(match.pmid)}`) ||
      (match.doi && `doi:${normalizeValue(match.doi)}`) ||
      `title:${normalizeTitle(match.title)}`;

    if (!featuredPublicationKeys.has(matchKey)) {
      featuredPublicationKeys.add(matchKey);
      ordered.push(match);
    }

    return ordered;
  }, []);
---

<Layout title="Publications">
  <div class="container mx-auto py-8 px-4">
    <h1 class="text-4xl font-bold text-center mb-8">Publications</h1>
    
    <PublicationsTabsLoaded client:load
      publications={publicationsData}
      featuredPublications={featuredPublications}
    />
  </div>
</Layout> 
